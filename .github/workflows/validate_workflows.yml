name: Validate Workflow YAMLs

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  yaml-validate:
    name: Validate workflow YAML files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show files being validated
        run: |
          echo "Listing .github/workflows:"
          ls -la .github/workflows || true

      - name: Install Python YAML parser
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Validate each workflow YAML and show errors
        id: validate
        run: |
          set -e
          python - <<'PY'
import glob, yaml, sys, traceback, os, textwrap

files = sorted(glob.glob('.github/workflows/*.yml') + glob.glob('.github/workflows/*.yaml'))
if not files:
    print("No workflow files found in .github/workflows/")
    sys.exit(0)

exit_code = 0
for p in files:
    print("\n" + "="*80)
    print("Checking:", p)
    print("-"*80)
    try:
        s = open(p, "r", encoding="utf-8").read()
        # Try safe_load to catch YAML syntax errors
        yaml.safe_load(s)
        print("PARSE OK")
    except Exception as e:
        exit_code = 1
        print("PARSE ERROR:", e)
        # Try to extract a line number if present in error text
        try:
            err = str(e)
            import re
            m = re.search(r'line (\\d+)', err)
            if m:
                ln = int(m.group(1))
                start = max(1, ln-4)
                end = ln+4
                print(f"\nContext (lines {start}-{end}):\n")
                with open(p, "r", encoding="utf-8") as fh:
                    for i, L in enumerate(fh, start=1):
                        if start <= i <= end:
                            prefix = f'{i:4d}: '
                            # mark error line
                            if i == ln:
                                print(prefix + ">> " + L.rstrip())
                            else:
                                print(prefix + "   " + L.rstrip())
            else:
                # fallback: print first 2000 chars of file for context
                print("\nFile preview:\n")
                print(textwrap.indent(s[:2000], "    "))
        except Exception:
            print("Failed to show context traceback:")
            traceback.print_exc()
print("\n" + "="*80)
if exit_code != 0:
    print("One or more workflow files failed YAML parse.")
    sys.exit(exit_code)
else:
    print("All workflow YAML files parsed OK.")
PY

      - name: Fail on invalid YAML (if found)
        if: failure()
        run: |
          echo "One or more workflow files are invalid YAML. See logs above."

